name: Merge subtrees

on:
  # push:
    # branches:
    #   - master
    # paths-ignore:
    #   - .github/workflows/subtree.yml

  workflow_dispatch:

# Some variables are set in the organization secrets
env:
  CI_SERVER_HOST: github.com
  GROUP: ${{ github.repository_owner }}
  AUTH_TOKEN: "x-access-token:${{ secrets.PHREEQC_BOT_TOKEN }}"
jobs:
  container-sync-subtrees:
    runs-on: ubuntu-latest
    container:
      image: buildpack-deps:bionic-scm
    steps:
      - name: Debug
        run: |
          git --version
          uname -a
          echo "CI_SERVER_HOST: ${CI_SERVER_HOST}"
          echo "GROUP: ${GROUP}"
          printenv | sort -u

      - name: Debug 2
        run: |
          git clone ${{ github.server_url }}/${{ github.repository }}
          cd ${{ github.event.repository.name }}
          git --version
          echo "Current directory: $(pwd)"
          echo "Current branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Current remote: $(git remote -v)"
          echo "Current status:"
          echo "----------------------------------------"
          git status
          git remote -v

      - name: Setup git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"          


  sync-subtrees:
    runs-on: ubuntu-latest
    steps:
      - name: Debug
        run: |
          git --version
          echo "CI_SERVER_HOST: ${CI_SERVER_HOST}"
          echo "GROUP: ${GROUP}"
          echo "AUTH_TOKEN: ${AUTH_TOKEN}"
          echo "https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}/iphreeqc.git"
          echo https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}/iphreeqc.git
          echo "https://x-access-token:${{ secrets.PHREEQC_BOT_TOKEN }}@github.com/iphreeqc.git"
          echo https://x-access-token:${{ secrets.PHREEQC_BOT_TOKEN }}@github.com/iphreeqc.git
          exit 1

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
          ref: master     # Checkout the master branch

      - name: Debug 2
        run: |
          echo "Current directory: $(pwd)"
          echo "Current branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Current remote: $(git remote -v)"
          echo "Current status:"
          echo "----------------------------------------"
          git status
          git remote -v

      - name: Setup git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Sync subtrees
        run: |
          #!/bin/bash -ex
          #
          # Note: need to change the protocol to https
          # ssh   -- git@github.com:usgs-coupled/iphreeqc.git
          # https -- https://${AUTH_TOKEN}@github.com/usgs-coupled/iphreeqc.git
          #
          # iphreeqc/              https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}/iphreeqc.git
          # ├─database/            ├─https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc3-database.git*                                  database*
          # ├─examples/            │ └─examples
          # │ ├─c/                 │   ├─https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc-commanuscript-cgfinal-examples-c.git*       examples/c*
          # │ ├─com/               │   ├─https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc-commanuscript-cgfinal-examples-com.git*     examples/com*
          # │ └─fortran/           │   └─https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc-COMManuscript-CGfinal-examples-fortran.git* examples/fortran*
          # ├─phreeqc3-doc/        ├─https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc3-doc.git*                                       phreeqc3-doc*
          # ├─phreeqc3-examples/   ├─https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc3-examples.git*                                  phreeqc3-examples*
          # └─src/                 └─https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/iphreeqc-src.git%                                       src%
          #   └─phreeqcpp/           └─https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc3-src.git                                      src/phreeqcpp
          #     └─common/              └─https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc3-src-common.git                             src/phreeqcpp/common

          # git_subtree() {
          #   # git subtree "${1}" --prefix="${2}" "${4}" master 2>&1 | grep -v "^[[:digit:]].*/[[:digit:]].*"
          # }

          declare -A urls=( \
            ["iphreeqc-src"]="https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/iphreeqc-src.git" \
            ["phreeqc-commanuscript-cgfinal-examples-c"]="https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc-commanuscript-cgfinal-examples-c.git" \
            ["phreeqc-commanuscript-cgfinal-examples-com"]="https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc-commanuscript-cgfinal-examples-com.git" \
            ["phreeqc-COMManuscript-CGfinal-examples-fortran"]="https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc-COMManuscript-CGfinal-examples-fortran.git" \
            ["phreeqc3-database"]="https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc3-database.git" \
            ["phreeqc3-doc"]="https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc3-doc.git" \
            ["phreeqc3-examples"]="https://${AUTH_TOKEN}@${CI_SERVER_HOST}/${GROUP}-subtrees/phreeqc3-examples.git" \
          )

          declare -A prefixes=( \
            ["iphreeqc-src"]="src" \
            ["phreeqc-commanuscript-cgfinal-examples-c"]="examples/c" \
            ["phreeqc-commanuscript-cgfinal-examples-com"]="examples/com" \
            ["phreeqc-COMManuscript-CGfinal-examples-fortran"]="examples/fortran" \
            ["phreeqc3-database"]="database" \
            ["phreeqc3-doc"]="phreeqc3-doc" \
            ["phreeqc3-examples"]="phreeqc3-examples" \
          )

          export GIT_EDITOR=true

          for remote in "${!urls[@]}"; do
            git subtree pull --prefix "${prefixes[$remote]}" --squash "${urls[$remote]}" master
          done

          echo "----------------------------------------"
          echo "Subtrees pulled successfully. Now pushing changes back to the subtrees."
          echo "----------------------------------------"

          # for remote in "${!urls[@]}"; do
          #   echo "Pushing changes to ${remote} at ${urls[$remote]} with prefix ${prefixes[$remote]}"
          #   git subtree push --prefix="${prefixes[$remote]}" "${urls[$remote]}" master-push-test
          # done

          git subtree push --prefix="src" "https://github.com/usgs-coupled-subtrees/iphreeqc-src.git" master

          echo git push origin master
          echo git status


